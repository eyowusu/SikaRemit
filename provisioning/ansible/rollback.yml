---
- name: Rollback SikaRemit Configuration
  hosts: all
  vars:
    backup_version: "20251031_120000"
  tasks:
    - name: Validate backup exists
      uri:
        url: "https://backups.sikaremit.com/sikaremit_config_{{ backup_version }}.zip"
        method: HEAD
      register: backup_check
      failed_when: backup_check.status != 200

    - name: Create restore point
      command: ./scripts/backup_config.sh
      args:
        chdir: /opt/sikaremit

    - name: Download backup
      unarchive:
        src: "https://backups.sikaremit.com/sikaremit_config_{{ backup_version }}.zip"
        dest: "/tmp/rollback"
        remote_src: yes

    - name: Verify backup contents
      assert:
        that:
          - "'alerts.py' in lookup('fileglob', '/tmp/rollback/backend/core/*.py')"
          - "'settings.py' in lookup('fileglob', '/tmp/rollback/backend/core/*.py')"

    - name: Restore configuration
      copy:
        src: "/tmp/rollback/{{ item }}"
        dest: "{{ item }}"
        backup: yes
      with_items:
        - .env
        - backend/core/alerts.py
        - backend/core/settings.py

    - name: Restart services
      systemd:
        name: sikaremit
        state: restarted
